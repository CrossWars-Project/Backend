name: Generate Daily Crosswords

on:
  schedule:
    # Runs at midnight UTC every day (8 AM UTC = midnight PST)
    - cron: '0 8 * * *'
  
  # Allows manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  generate-crosswords:
    runs-on: ubuntu-latest
    
    steps:
    # Since we are using the free version of Render, we need to wake up the backend service first
    # it will auto sleep after 15 min of no activity, so ping it first to wake and then wait 30 sec.
      - name: Wake Render Backend
        run: |
          echo "üîî Warming up Render backend..."
          curl -s https://backend-ezw4.onrender.com/health || true
          sleep 30
      # Generate the daily crosswords and retry up to 5 times if it fails
      - name: Generate Daily Crosswords (with retry)
        run: |
          echo "üéØ Generating daily crosswords at $(date)"

          max_attempts=5
          attempt=1
          success=false

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."

            response=$(curl -X POST https://backend-ezw4.onrender.com/crossword/generate-daily \
              -H "Content-Type: application/json" \
              -w "\n%{http_code}" \
              -s \
              --max-time 300)

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "Response body: $body"
            echo "HTTP status: $http_code"

            if [ "$http_code" -eq 200 ]; then
              echo "‚úÖ Daily crosswords generated successfully!"
              success=true
              break
            fi

            echo "‚ùå Failed (HTTP $http_code). Waiting before retry..."
            sleep 15
            attempt=$((attempt + 1))
          done

          if [ "$success" = false ]; then
            echo "‚ùå All attempts failed."
            exit 1
          fi
      
      - name: Summary
        if: success()
        run: echo "‚úÖ Crosswords generated and saved to backend at $(date)"